---
import { getCollection } from 'astro:content';
import TravelLayout from '../../layouts/TravelLayout.astro';
import Pile from '../../components/Pile.tsx';

const travelEntries = (await getCollection('travel'))
	.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// Group entries by year and generate data for each year
const yearGroups = new Map();
travelEntries.forEach(entry => {
	const year = entry.data.publishDate.getFullYear();
	if (!yearGroups.has(year)) {
		yearGroups.set(year, []);
	}
	yearGroups.get(year).push(entry);
});

// Helper function to get all images from entries
function getAllImagesFromEntries(entries: any[]): string[] {
	const allImages: string[] = [];
	
	entries.forEach(entry => {
		// Add multiple images if they exist
		if (entry.data.images && entry.data.images.length > 0) {
			allImages.push(...entry.data.images);
		}
		
		// Add single image if it exists
		if (entry.data.image) {
			allImages.push(entry.data.image);
		}
	});
	
	return allImages;
}

// Helper function to get random images for the pile
function getRandomImagesForPile(allImages: string[]): string[] {
	const images: string[] = [];
	
	if (allImages.length === 0) {
		// Use placeholder images if no images are available
		return [
			'/assets/about/img-1.jpg',
			'/assets/about/img-2.jpg',
			'/assets/about/img-3.jpg',
			'/assets/about/img-4.jpg',
			'/assets/about/img-5.jpg'
		];
	}
	
	// If we have fewer than 5 images, duplicate some randomly
	const availableImages = [...allImages];
	while (images.length < 5) {
		if (availableImages.length === 0) {
			// If we've used all images, reset the available pool
			availableImages.push(...allImages);
		}
		
		const randomIndex = Math.floor(Math.random() * availableImages.length);
		images.push(availableImages[randomIndex]);
		availableImages.splice(randomIndex, 1);
	}
	
	return images;
}

// Generate pile data for each year
const yearPiles = Array.from(yearGroups.entries())
	.sort(([a], [b]) => b - a) // Sort years descending
	.map(([year, entries]) => {
		const yearImages = getAllImagesFromEntries(entries);
		const pileImages = getRandomImagesForPile(yearImages);
		
		return {
			year: year.toString(),
			images: pileImages,
			href: `/travel/${year}`
		};
	});

---

<TravelLayout title="Travel">
	<div class="hero-wrapper stack gap-20">
		<div class="travel-hero title">
			<h1>Trips</h1>
			<p>I organize trips by year, beginning with my first major adventure as an adult to South America in 2015.</p>
		</div>
		
		
			<div class="pile-container">
				{yearPiles.map((pile) => (
					<Pile
						images={pile.images}
						href={pile.href}
						year={pile.year}
						title={pile.year}
						client:load
					/>
				))}
			</div>
		
	</div>
</TravelLayout>

<style>
	.travel-hero {
		text-align: left;
	}

	.travel-hero h1 {
		font-size: var(--text-2xl);
		color: var(--gray-0);
		margin-bottom: 1rem;
	}

	.travel-hero p {
		font-size: var(--text-lg);
		color: var(--gray-300);
	}

	.section {
		width: 100%;
	}

	.pile-container {
		display: grid;
		grid-auto-rows: 1fr;
		gap: 40px;
		list-style: none;
		padding: 0;
		width: 100%;
		justify-items: center;
		grid-template-columns: 1fr;
	}

	@media (min-width: 1344px) {
		.pile-container {
			grid-template-columns: 1fr 1fr;
			gap: 32px;
		}
	}

	@media (min-width: 60em) {
		.travel-hero h1 {
			font-size: var(--text-3xl);
		}
	}
</style> 